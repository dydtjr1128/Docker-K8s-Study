# 1. 도커 스웜

도커 스웜은 여러 도커 호스트를 클러스터로 묶어주는 컨테이너 오케스트레이션 도구의 한 종류입니다.

앞서 배웠던 도커 컴포즈와 비슷한 역할을 하지만 주로 멀티 호스트 상황에서 쓰입니다.

| 이름 | 역할 | 명령어 |
| :--- | :--- | :--- |
| 컴포즈 | 여러 컨테이너로 구성된 도커 어플리케이션을 관리\(주로 단일 호스트\) | docker-compose |
| 스웜 | 클러스터 구축 및 관리\(주로 멀티 호스트\) | docker swarm |
| 서비스 | 스웜에서 클러스터 안의 서비스\(컨테이너 하나 이상의 집합\)을 관리 | docker service |
| 스택 | 스웜에서 여러 개의 서비스를 합한 전체 어플리케이션을 관리 | docker stack |

이번에는 dind를 이용해서 테스트를 진행 해 보도록 하겠습니다. 

## dind

dind\(docker in docker\)는 도커 호스트 역할을 할 도커 컨테이너를 여러개 실행하는 방법입니다. 가상머신 등의 리소스가 많이드는 작업이 아니기 때문에 굉장히 유용합니다. 이번 장에서는 크게 3가지 컨테이너를 사용하려고 합니다.

* registry x1 : 도커 레지스트리 역할을 할 컨테이너로 manager 및 worker 컨테이너가 사용하는 컨테이너입 니다. dind  환경에서는 외부 도커의 이미지를 가져올 수 없으므로 registry 컨테이너에 등록 했다가 manager 및 worker 컨테이너에서 이미지를 받아가는 역할을 합니다.
* manager x1 : 스웜 클러스터 전체를 제어하는 역할을 합니다. 여러 대 실해오디는 도커 호스트\(worker\)에 서비스가 담긴 컨테이너를 적절히 배치합니다.
* worker x3 : 서비스가 담긴 컨테이너를 수행해주는 컨테이너입니다.

## dind 설치하기

{% tabs %}
{% tab title="docker-compose.yml" %}
```text
version: "3"
services:
  registry:
    container_name: registry
    image: registry:2.6
    ports:
      - 5000:5000
    volumes:
      - "./registry-data:/var/lib/registry"

  manager:
    container_name: manager
    image: docker:18.05.0-ce-dind
    privileged: true
    tty: true
    ports:
      - 8000:80
      - 9000:9000
    depends_on:
      - registry
    expose:
      - 3375
    command: "--insecure-registry registry:5000"
    volumes:
      - "./stack:/stack"

  worker01:
    container_name: worker01
    image: docker:18.05.0-ce-dind
    privileged: true
    tty: true
    depends_on:
      - manager
      - registry
    expose:
      - 7946
      - 7946/udp
      - 4789/udp
    command: "--insecure-registry registry:5000"

  worker02:
    container_name: worker02
    image: docker:18.05.0-ce-dind
    privileged: true
    tty: true
    depends_on:
      - manager
      - registry
    expose:
      - 7946
      - 7946/udp
      - 4789/udp
    command: "--insecure-registry registry:5000"

  worker03:
    container_name: worker03
    image: docker:18.05.0-ce-dind
    privileged: true
    tty: true
    depends_on:
      - manager
      - registry
    expose:
      - 7946
      - 7946/udp
      - 4789/udp
    command: "--insecure-registry registry:5000"
```
{% endtab %}
{% endtabs %}

위와 같은 yml 파일을 만들어주고 `docker-compose up -d`명령으로 실행 해 줍니다.

docker container ls 명령으로 총 4개가 정상적으로 실행되는것을 확인 할 수 있습니다.

그 후에 `docker container exec -it manager docker swarm init` 명령으로 마스터와 워커들간 연결을 위한 키를 발급받습니다.

![SWMTKN&#xC73C;&#xB85C; &#xC2DC;&#xC791;&#xD558;&#xB294; &#xC2A4;&#xC6DC; &#xD1A0;&#xD070;](../.gitbook/assets/image%20%283%29.png)

그 후 워커들과 키를 이용해 연결해 줍니다.

```bash
 docker container exec -it worker01 docker swarm join --token SWMTKN-1-1ztmzkbz1j4a0fonsy5msw37pojxk7laxaoo1wker0h4sdqgvm-d918kykw8z3zk9l7f5fge4o9r 172.18.0.3:2377
 docker container exec -it worker02 docker swarm join --token SWMTKN-1-1ztmzkbz1j4a0fonsy5msw37pojxk7laxaoo1wker0h4sdqgvm-d918kykw8z3zk9l7f5fge4o9r 172.18.0.3:2377
 docker container exec -it worker03 docker swarm join --token SWMTKN-1-1ztmzkbz1j4a0fonsy5msw37pojxk7laxaoo1wker0h4sdqgvm-d918kykw8z3zk9l7f5fge4o9r 172.18.0.3:2377
```

`docker container exec -it manager docker node ls` 명령으로 연결된 노드를 확인 할 수 있습니다.

## 도커 레지스트리에 이미지 등록하

